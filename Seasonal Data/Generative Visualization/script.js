const dataset = {
  sun: [
    {
      date: "2020-11-22",
      value: 75,
    },
    {
      date: "2020-11-29",
      value: 74,
    },
    {
      date: "2020-12-06",
      value: 76,
    },
    {
      date: "2020-12-13",
      value: 78,
    },
    {
      date: "2020-12-20",
      value: 76,
    },
    {
      date: "2020-12-27",
      value: 81,
    },
    {
      date: "2021-01-03",
      value: 79,
    },
    {
      date: "2021-01-10",
      value: 77,
    },
    {
      date: "2021-01-17",
      value: 79,
    },
    {
      date: "2021-01-24",
      value: 75,
    },
    {
      date: "2021-01-31",
      value: 80,
    },
    {
      date: "2021-02-07",
      value: 77,
    },
    {
      date: "2021-02-14",
      value: 78,
    },
    {
      date: "2021-02-21",
      value: 82,
    },
    {
      date: "2021-02-28",
      value: 80,
    },
    {
      date: "2021-03-07",
      value: 85,
    },
    {
      date: "2021-03-14",
      value: 81,
    },
    {
      date: "2021-03-21",
      value: 82,
    },
    {
      date: "2021-03-28",
      value: 85,
    },
    {
      date: "2021-04-04",
      value: 86,
    },
    {
      date: "2021-04-11",
      value: 86,
    },
    {
      date: "2021-04-18",
      value: 91,
    },
    {
      date: "2021-04-25",
      value: 89,
    },
    {
      date: "2021-05-02",
      value: 88,
    },
    {
      date: "2021-05-09",
      value: 89,
    },
    {
      date: "2021-05-16",
      value: 92,
    },
    {
      date: "2021-05-23",
      value: 95,
    },
    {
      date: "2021-05-30",
      value: 100,
    },
    {
      date: "2021-06-06",
      value: 99,
    },
    {
      date: "2021-06-13",
      value: 98,
    },
    {
      date: "2021-06-20",
      value: 91,
    },
    {
      date: "2021-06-27",
      value: 93,
    },
    {
      date: "2021-07-04",
      value: 89,
    },
    {
      date: "2021-07-11",
      value: 96,
    },
    {
      date: "2021-07-18",
      value: 98,
    },
    {
      date: "2021-07-25",
      value: 87,
    },
    {
      date: "2021-08-01",
      value: 82,
    },
    {
      date: "2021-08-08",
      value: 86,
    },
    {
      date: "2021-08-15",
      value: 82,
    },
    {
      date: "2021-08-22",
      value: 80,
    },
    {
      date: "2021-08-29",
      value: 78,
    },
    {
      date: "2021-09-05",
      value: 82,
    },
    {
      date: "2021-09-12",
      value: 78,
    },
    {
      date: "2021-09-19",
      value: 78,
    },
    {
      date: "2021-09-26",
      value: 77,
    },
    {
      date: "2021-10-03",
      value: 78,
    },
    {
      date: "2021-10-10",
      value: 76,
    },
    {
      date: "2021-10-17",
      value: 75,
    },
    {
      date: "2021-10-24",
      value: 77,
    },
    {
      date: "2021-10-31",
      value: 72,
    },
    {
      date: "2021-11-07",
      value: 76,
    },
    {
      date: "2021-11-14",
      value: 74,
    },
  ],
  moon: [
    {
      date: "2020-11-22",
      value: 53,
    },
    {
      date: "2020-11-29",
      value: 60,
    },
    {
      date: "2020-12-06",
      value: 51,
    },
    {
      date: "2020-12-13",
      value: 51,
    },
    {
      date: "2020-12-20",
      value: 52,
    },
    {
      date: "2020-12-27",
      value: 72,
    },
    {
      date: "2021-01-03",
      value: 54,
    },
    {
      date: "2021-01-10",
      value: 55,
    },
    {
      date: "2021-01-17",
      value: 53,
    },
    {
      date: "2021-01-24",
      value: 65,
    },
    {
      date: "2021-01-31",
      value: 54,
    },
    {
      date: "2021-02-07",
      value: 53,
    },
    {
      date: "2021-02-14",
      value: 54,
    },
    {
      date: "2021-02-21",
      value: 68,
    },
    {
      date: "2021-02-28",
      value: 60,
    },
    {
      date: "2021-03-07",
      value: 55,
    },
    {
      date: "2021-03-14",
      value: 54,
    },
    {
      date: "2021-03-21",
      value: 60,
    },
    {
      date: "2021-03-28",
      value: 66,
    },
    {
      date: "2021-04-04",
      value: 53,
    },
    {
      date: "2021-04-11",
      value: 60,
    },
    {
      date: "2021-04-18",
      value: 67,
    },
    {
      date: "2021-04-25",
      value: 99,
    },
    {
      date: "2021-05-02",
      value: 54,
    },
    {
      date: "2021-05-09",
      value: 64,
    },
    {
      date: "2021-05-16",
      value: 55,
    },
    {
      date: "2021-05-23",
      value: 100,
    },
    {
      date: "2021-05-30",
      value: 53,
    },
    {
      date: "2021-06-06",
      value: 53,
    },
    {
      date: "2021-06-13",
      value: 51,
    },
    {
      date: "2021-06-20",
      value: 71,
    },
    {
      date: "2021-06-27",
      value: 51,
    },
    {
      date: "2021-07-04",
      value: 51,
    },
    {
      date: "2021-07-11",
      value: 54,
    },
    {
      date: "2021-07-18",
      value: 76,
    },
    {
      date: "2021-07-25",
      value: 55,
    },
    {
      date: "2021-08-01",
      value: 50,
    },
    {
      date: "2021-08-08",
      value: 52,
    },
    {
      date: "2021-08-15",
      value: 56,
    },
    {
      date: "2021-08-22",
      value: 65,
    },
    {
      date: "2021-08-29",
      value: 50,
    },
    {
      date: "2021-09-05",
      value: 50,
    },
    {
      date: "2021-09-12",
      value: 54,
    },
    {
      date: "2021-09-19",
      value: 71,
    },
    {
      date: "2021-09-26",
      value: 47,
    },
    {
      date: "2021-10-03",
      value: 51,
    },
    {
      date: "2021-10-10",
      value: 50,
    },
    {
      date: "2021-10-17",
      value: 70,
    },
    {
      date: "2021-10-24",
      value: 62,
    },
    {
      date: "2021-10-31",
      value: 48,
    },
    {
      date: "2021-11-07",
      value: 53,
    },
    {
      date: "2021-11-14",
      value: 66,
    },
  ],
}

const icons = {
  sun: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="-50 -50 100 100" width="200" height="200">
      <defs>
        <linearGradient id="gs" x1="-50" x2="50" y1="-50" y2="50">
          <stop stop-color="hsl(0, 0%, 0%)" offset="0" />
          <stop stop-color="hsl(0, 0%, 100%)" offset="1" />
        </linearGradient>
        <mask id="ms">
          <rect x="-50" y="-50" width="100" height="100" fill="url(#gs)" />
        </mask>
      </defs>

      <rect x="-30" y="-30" width="60" height="60" rx="5" fill="hsl(53, 97%, 53%)" />
      <rect x="-30" y="-30" width="60" height="60" rx="5" fill="hsl(45, 98%, 51%)" mask="url(#ms)" />
      <rect x="-30" y="-30" width="60" height="60" rx="5" transform="rotate(45)" fill="hsl(53, 97%, 53%)" />
      <rect x="-30" y="-30" width="60" height="60" rx="5" transform="rotate(45)" fill="hsl(45, 98%, 51%)" mask="url(#ms)" />
    </svg>
  `,
  moon: `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="-50 -50 100 100" width="200" height="200">
    <defs>
      <linearGradient id="gm" x1="-50" x2="50" y1="-50" y2="50">
        <stop stop-color="hsl(0, 0%, 0%)" offset="0" />
        <stop stop-color="hsl(0, 0%, 100%)" offset="1" />
      </linearGradient>
      <mask id="mm">
        <rect x="-50" y="-50" width="100" height="100" fill="url(#gm)" />
      </mask>
    </defs>

    <g transform="translate(-5 0) rotate(-20)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round">
      <path fill="hsl(244, 97%, 53%)" stroke="hsl(244, 97%, 53%)" d="M 20 -25 A 30 30 0 1 0 20 25 32.5 32.5 0 0 1 20 -25" />
      <path fill="hsl(242, 98%, 50%)" stroke="hsl(242, 98%, 50%)" mask="url(#mm)" d="M 20 -25 A 30 30 0 1 0 20 25 32.5 32.5 0 0 1 20 -25" />
    </g>
  </svg>
`,
}

const { select, scaleLinear, timeParse, timeFormat, scaleTime, extent, line } =
  d3

const root = d3.select("body").append("div").attr("id", "root")

const header = root.append("header")
header.append("h1").text("Seasonal Data")
header
  .append("p")
  .html(
    "<time datetime='2021-11-22'>Over the span of twelve months</time> Google Trends highlights an interesting pattern for the keywords <a href='https://trends.google.com/trends/explore?q=sun'>sun</a> and <a href='https://trends.google.com/trends/explore?q=moon'>moon</a>."
  )

function draw({ title, description, key }) {
  const data = dataset[key]

  const parseDate = timeParse("%Y-%m-%d")
  const formatDate = timeFormat("%B %-d, %Y")

  const xAccessor = (d) => parseDate(d.date)
  const yAccessor = (d) => d.value

  const yIconScale = scaleLinear().domain([0, 100]).range([120, 0])

  const xLineScale = scaleTime().domain(extent(data, xAccessor)).range([0, 200])
  const yLineScale = scaleLinear().domain(yIconScale.domain()).range([20, 0])

  const lineGenerator = line()
    .x((d) => xLineScale(xAccessor(d)))
    .y((d) => yLineScale(yAccessor(d)))

  const article = root.append("article")
  article.append("h2").text(title).style("text-transform", "capitalize")
  article.append("p").text(description)

  const wrapper = article
    .append("svg")
    .attr("viewBox", `0 0 230 450`)
    .attr("width", 230)
    .attr("height", 450)

  const bounds = wrapper.append("g").attr("transform", `translate(10 10)`)

  const iconGroup = bounds.append("g")
  const lineGroup = bounds.append("g").attr("transform", "translate(0 320)")
  const textGroup = bounds.append("g").attr("transform", "translate(200 390)")

  iconGroup.append("g").html(icons[key])

  lineGroup
    .append("path")
    .attr("fill", "none")
    .attr("stroke", "currentColor")
    .attr("stroke-width", "2")

  textGroup
    .attr("text-anchor", "end")
    .attr("fill", "currentColor")
    .attr("font-family", "inherit")

  textGroup.append("text").attr("font-size", "56").attr("font-weight", "bold")

  textGroup.append("text").attr("y", "30").attr("font-size", "22")

  iconGroup.attr("transform", `translate(0 ${yIconScale(yAccessor(data[0]))})`)

  lineGroup.select("path").attr("d", lineGenerator(data.slice(0, 0)))

  textGroup.select("text").text(yAccessor(data[0]))

  textGroup.select("text:nth-of-type(2)").text(formatDate(xAccessor(data[0])))

  const controls = article.append("div")
  const button = controls.append("button")

  button.append("span").text("Animate")

  const input = controls
    .append("input")
    .attr("type", "range")
    .attr("min", 0)
    .attr("max", data.length - 1)
    .attr("value", 0)

  let transition
  function animate(value = 0) {
    transition = d3.transition().duration(250).ease(d3.easeLinear)

    lineGroup.select("path").attr("d", lineGenerator(data.slice(0, value)))

    textGroup.select("text").text(yAccessor(data[value]))

    textGroup
      .select("text:nth-of-type(2)")
      .text(formatDate(xAccessor(data[value])))

    input.attr("value", value)

    iconGroup
      .transition(transition)
      .attr("transform", `translate(0 ${yIconScale(yAccessor(data[value]))})`)
      .on("end", () => {
        if (value < data.length - 1) animate(value + 1)
      })
  }

  button.on("click", () => {
    iconGroup.interrupt()

    animate()
  })

  input
    .on("mousedown", () => {
      iconGroup.interrupt()
    })
    .on("input", (e) => {
      const value = parseInt(e.currentTarget.value, 10)

      lineGroup.select("path").attr("d", lineGenerator(data.slice(0, value)))

      textGroup.select("text").text(yAccessor(data[value]))

      textGroup
        .select("text:nth-of-type(2)")
        .text(formatDate(xAccessor(data[value])))
    })
    .on("change", (e) => {
      const value = parseInt(e.currentTarget.value, 10)

      // if run on input I feel the transition is run too frequently and changes are less apparent
      iconGroup
        .transition()
        .attr("transform", `translate(0 ${yIconScale(yAccessor(data[value]))})`)
    })
}

draw({
  title: "sun",
  description:
    "Search interest steadily grows and then recedes without changing excessively.",
  key: "sun",
})

draw({
  title: "moon",
  description:
    "Search interest fluctuates continuously in smaller, month-long periods.",
  key: "moon",
})
