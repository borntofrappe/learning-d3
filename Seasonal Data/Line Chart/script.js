const dataset = {
  sun: [
    {
      date: "2020-11-22",
      value: 75,
    },
    {
      date: "2020-11-29",
      value: 74,
    },
    {
      date: "2020-12-06",
      value: 76,
    },
    {
      date: "2020-12-13",
      value: 78,
    },
    {
      date: "2020-12-20",
      value: 76,
    },
    {
      date: "2020-12-27",
      value: 81,
    },
    {
      date: "2021-01-03",
      value: 79,
    },
    {
      date: "2021-01-10",
      value: 77,
    },
    {
      date: "2021-01-17",
      value: 79,
    },
    {
      date: "2021-01-24",
      value: 75,
    },
    {
      date: "2021-01-31",
      value: 80,
    },
    {
      date: "2021-02-07",
      value: 77,
    },
    {
      date: "2021-02-14",
      value: 78,
    },
    {
      date: "2021-02-21",
      value: 82,
    },
    {
      date: "2021-02-28",
      value: 80,
    },
    {
      date: "2021-03-07",
      value: 85,
    },
    {
      date: "2021-03-14",
      value: 81,
    },
    {
      date: "2021-03-21",
      value: 82,
    },
    {
      date: "2021-03-28",
      value: 85,
    },
    {
      date: "2021-04-04",
      value: 86,
    },
    {
      date: "2021-04-11",
      value: 86,
    },
    {
      date: "2021-04-18",
      value: 91,
    },
    {
      date: "2021-04-25",
      value: 89,
    },
    {
      date: "2021-05-02",
      value: 88,
    },
    {
      date: "2021-05-09",
      value: 89,
    },
    {
      date: "2021-05-16",
      value: 92,
    },
    {
      date: "2021-05-23",
      value: 95,
    },
    {
      date: "2021-05-30",
      value: 100,
    },
    {
      date: "2021-06-06",
      value: 99,
    },
    {
      date: "2021-06-13",
      value: 98,
    },
    {
      date: "2021-06-20",
      value: 91,
    },
    {
      date: "2021-06-27",
      value: 93,
    },
    {
      date: "2021-07-04",
      value: 89,
    },
    {
      date: "2021-07-11",
      value: 96,
    },
    {
      date: "2021-07-18",
      value: 98,
    },
    {
      date: "2021-07-25",
      value: 87,
    },
    {
      date: "2021-08-01",
      value: 82,
    },
    {
      date: "2021-08-08",
      value: 86,
    },
    {
      date: "2021-08-15",
      value: 82,
    },
    {
      date: "2021-08-22",
      value: 80,
    },
    {
      date: "2021-08-29",
      value: 78,
    },
    {
      date: "2021-09-05",
      value: 82,
    },
    {
      date: "2021-09-12",
      value: 78,
    },
    {
      date: "2021-09-19",
      value: 78,
    },
    {
      date: "2021-09-26",
      value: 77,
    },
    {
      date: "2021-10-03",
      value: 78,
    },
    {
      date: "2021-10-10",
      value: 76,
    },
    {
      date: "2021-10-17",
      value: 75,
    },
    {
      date: "2021-10-24",
      value: 77,
    },
    {
      date: "2021-10-31",
      value: 72,
    },
    {
      date: "2021-11-07",
      value: 76,
    },
    {
      date: "2021-11-14",
      value: 74,
    },
  ],
  moon: [
    {
      date: "2020-11-22",
      value: 53,
    },
    {
      date: "2020-11-29",
      value: 60,
    },
    {
      date: "2020-12-06",
      value: 51,
    },
    {
      date: "2020-12-13",
      value: 51,
    },
    {
      date: "2020-12-20",
      value: 52,
    },
    {
      date: "2020-12-27",
      value: 72,
    },
    {
      date: "2021-01-03",
      value: 54,
    },
    {
      date: "2021-01-10",
      value: 55,
    },
    {
      date: "2021-01-17",
      value: 53,
    },
    {
      date: "2021-01-24",
      value: 65,
    },
    {
      date: "2021-01-31",
      value: 54,
    },
    {
      date: "2021-02-07",
      value: 53,
    },
    {
      date: "2021-02-14",
      value: 54,
    },
    {
      date: "2021-02-21",
      value: 68,
    },
    {
      date: "2021-02-28",
      value: 60,
    },
    {
      date: "2021-03-07",
      value: 55,
    },
    {
      date: "2021-03-14",
      value: 54,
    },
    {
      date: "2021-03-21",
      value: 60,
    },
    {
      date: "2021-03-28",
      value: 66,
    },
    {
      date: "2021-04-04",
      value: 53,
    },
    {
      date: "2021-04-11",
      value: 60,
    },
    {
      date: "2021-04-18",
      value: 67,
    },
    {
      date: "2021-04-25",
      value: 99,
    },
    {
      date: "2021-05-02",
      value: 54,
    },
    {
      date: "2021-05-09",
      value: 64,
    },
    {
      date: "2021-05-16",
      value: 55,
    },
    {
      date: "2021-05-23",
      value: 100,
    },
    {
      date: "2021-05-30",
      value: 53,
    },
    {
      date: "2021-06-06",
      value: 53,
    },
    {
      date: "2021-06-13",
      value: 51,
    },
    {
      date: "2021-06-20",
      value: 71,
    },
    {
      date: "2021-06-27",
      value: 51,
    },
    {
      date: "2021-07-04",
      value: 51,
    },
    {
      date: "2021-07-11",
      value: 54,
    },
    {
      date: "2021-07-18",
      value: 76,
    },
    {
      date: "2021-07-25",
      value: 55,
    },
    {
      date: "2021-08-01",
      value: 50,
    },
    {
      date: "2021-08-08",
      value: 52,
    },
    {
      date: "2021-08-15",
      value: 56,
    },
    {
      date: "2021-08-22",
      value: 65,
    },
    {
      date: "2021-08-29",
      value: 50,
    },
    {
      date: "2021-09-05",
      value: 50,
    },
    {
      date: "2021-09-12",
      value: 54,
    },
    {
      date: "2021-09-19",
      value: 71,
    },
    {
      date: "2021-09-26",
      value: 47,
    },
    {
      date: "2021-10-03",
      value: 51,
    },
    {
      date: "2021-10-10",
      value: 50,
    },
    {
      date: "2021-10-17",
      value: 70,
    },
    {
      date: "2021-10-24",
      value: 62,
    },
    {
      date: "2021-10-31",
      value: 48,
    },
    {
      date: "2021-11-07",
      value: 53,
    },
    {
      date: "2021-11-14",
      value: 66,
    },
  ],
}

const {
  select,
  extent,
  max,
  scaleLinear,
  scaleTime,
  axisLeft,
  axisBottom,
  timeParse,
  timeFormat,
  line,
  pointer,
  least,
} = d3

const root = d3.select("body").append("div").attr("id", "root")

const header = root.append("header")
header.append("h1").text("Seasonal Data")
header
  .append("p")
  .html(
    "Over the span of twelve months, beginning <time datetime='2020-11-22'>November 22nd, 2020</time>, Google Trends highlights an interesting pattern for the keywords <a href='https://trends.google.com/trends/explore?q=sun'>sun</a> and <a href='https://trends.google.com/trends/explore?q=moon'>moon</a>."
  )

drawLinechart("sun")
drawLinechart("moon")

function drawLinechart(key) {
  const data = dataset[key]

  const dimensions = {
    width: 800,
    height: 200,
    margin: {
      top: 10,
      right: 10,
      bottom: 30,
      left: 30,
    },
  }

  dimensions.boundedWidth =
    dimensions.width - (dimensions.margin.left + dimensions.margin.right)
  dimensions.boundedHeight =
    dimensions.height - (dimensions.margin.top + dimensions.margin.bottom)

  const parseDate = timeParse("%Y-%m-%d")
  const formatDate = timeFormat("%B %d, %Y")

  const xAccessor = (d) => parseDate(d.date)
  const yAccessor = (d) => d.value

  const xScale = scaleTime()
    .domain(extent(data, xAccessor))
    .range([0, dimensions.boundedWidth])
    .nice()

  const yScale = scaleLinear()
    .domain([0, 100])
    .range([dimensions.boundedHeight, 0])

  const lineGenerator = line()
    .x((d) => xScale(xAccessor(d)))
    .y((d) => yScale(yAccessor(d)))

  const xAxis = axisBottom(xScale)
    .ticks(5)
    .tickSize(0)
    .tickFormat((d) => formatDate(d))

  const yAxis = axisLeft(yScale).ticks(4).tickSize(0)

  const article = root.append("article")
  article.append("h2").text(`Interest over time: ${key}`)

  const wrapper = article
    .append("svg")
    .attr("viewBox", `0 0 ${dimensions.width} ${dimensions.height}`)
    .attr("width", dimensions.width)
    .attr("height", dimensions.height)

  const bounds = wrapper
    .append("g")
    .attr(
      "transform",
      `translate(${dimensions.margin.left} ${dimensions.margin.top})`
    )

  const dataGroup = bounds.append("g")
  const axisGroup = bounds.append("g")
  const highlightGroup = bounds.append("g")

  dataGroup
    .append("path")
    .attr("d", lineGenerator(data))
    .attr("fill", "none")
    .attr("stroke", "hsl(207, 90%, 54%)")
    .attr("stroke-width", "3")

  const xAxisGroup = axisGroup
    .append("g")
    .attr("transform", `translate(0 ${dimensions.boundedHeight})`)
    .call(xAxis)

  const yAxisGroup = axisGroup.append("g").call(yAxis)

  axisGroup.selectAll("text").attr("fill", "hsl(0, 0%, 58%)")

  yAxisGroup.select("path").remove()
  yAxisGroup.select("g.tick").remove()
  yAxisGroup
    .selectAll("g.tick")
    .append("path")
    .attr("d", `M 0 0 h ${dimensions.boundedWidth}`)
    .attr("stroke-width", "0.5")
    .attr("stroke", "hsl(0, 0%, 84%)")

  xAxisGroup.select("path").attr("stroke", "hsl(0, 0%, 68%)")
  xAxisGroup.selectAll("text").attr("y", "6")

  highlightGroup.append("path")

  highlightGroup.append("path")

  highlightGroup
    .selectAll("path")
    .attr("fill", "none")
    .attr("stroke", "hsl(207, 90%, 54%)")
    .attr("stroke-width", "1.2")
    .attr("stroke-dasharray", "3 5")
    .attr("opacity", "0")

  highlightGroup
    .append("circle")
    .attr("r", "10")
    .attr("fill", "hsl(207, 90%, 54%)")
    .attr("opacity", "0.2")
    .attr("transform", "scale(0)")

  highlightGroup
    .append("circle")
    .attr("r", "6")
    .attr("fill", "hsl(207, 90%, 54%)")
    .attr("transform", "scale(0)")

  highlightGroup.append("text").attr("font-size", "24")

  highlightGroup.append("text").attr("font-size", "18")

  highlightGroup
    .selectAll("text")
    .attr("fill", "currentColor")
    .attr("font-family", "inherit")
    .attr("font-weight", "bold")
    .attr("opacity", "0")

  bounds
    .append("rect")
    .attr("width", dimensions.boundedWidth)
    .attr("height", dimensions.boundedHeight)
    .attr("opacity", "0")
    .on("mouseenter", () => {
      highlightGroup.selectAll("path").transition().attr("opacity", "1")
      highlightGroup.selectAll("text").transition().attr("opacity", "1")
      highlightGroup
        .selectAll("circle")
        .transition()
        .attr("transform", "scale(1)")
    })
    .on("mouseleave", () => {
      highlightGroup.selectAll("path").transition().attr("opacity", "0")
      highlightGroup.selectAll("text").transition().attr("opacity", "0")
      highlightGroup
        .selectAll("circle")
        .transition()
        .attr("transform", "scale(0)")
    })
    .on("mousemove", (e) => {
      const [x] = pointer(e)
      const date = xScale.invert(x)
      const d = least(
        data,
        (a, b) => Math.abs(xAccessor(a) - date) - Math.abs(xAccessor(b) - date)
      )

      const dx = xScale(xAccessor(d))
      const dy = yScale(yAccessor(d))

      highlightGroup.attr("transform", `translate(${dx} ${dy})`)

      highlightGroup
        .select("path")
        .attr("d", `M 0 0 v ${dimensions.boundedHeight - dy}`)

      highlightGroup.select("path:nth-of-type(2)").attr("d", `M 0 0 h -${dx}`)

      highlightGroup
        .select("text")
        .attr("x", -dx)
        .attr("y", dy > dimensions.boundedHeight / 2 ? "-10" : "30")
        .text(yAccessor(d))

      highlightGroup
        .select("text:nth-of-type(2)")
        .attr("x", dx > dimensions.boundedWidth / 2 ? "-8" : "8")
        .attr("y", dimensions.boundedHeight - dy - 5)
        .attr("text-anchor", dx > dimensions.boundedWidth / 2 ? "end" : "start")

        .text(formatDate(xAccessor(d)))
    })
}
