const data = {
  station: "Forest City",
  calm: 11.16,
  directions: [
    {
      angles: [355, 4],
      speed: [
        { interval: "2-4.9", value: 0.276 },
        { interval: "5-6.9", value: 0.374 },
        { interval: "7-9.9", value: 0.403 },
        { interval: "10-14.9", value: 0.659 },
        { interval: "15-19.9", value: 0.325 },
        { interval: "20+", value: 0.069 },
      ],
    },
    {
      angles: [5, 14],
      speed: [
        { interval: "2-4.9", value: 0.285 },
        { interval: "5-6.9", value: 0.285 },
        { interval: "7-9.9", value: 0.216 },
        { interval: "10-14.9", value: 0.315 },
        { interval: "15-19.9", value: 0.167 },
        { interval: "20+", value: 0.01 },
      ],
    },
    {
      angles: [15, 24],
      speed: [
        { interval: "2-4.9", value: 0.384 },
        { interval: "5-6.9", value: 0.187 },
        { interval: "7-9.9", value: 0.118 },
        { interval: "10-14.9", value: 0.226 },
        { interval: "15-19.9", value: 0.089 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [25, 34],
      speed: [
        { interval: "2-4.9", value: 0.187 },
        { interval: "5-6.9", value: 0.207 },
        { interval: "7-9.9", value: 0.089 },
        { interval: "10-14.9", value: 0.226 },
        { interval: "15-19.9", value: 0.108 },
        { interval: "20+", value: 0.03 },
      ],
    },
    {
      angles: [35, 44],
      speed: [
        { interval: "2-4.9", value: 0.177 },
        { interval: "5-6.9", value: 0.295 },
        { interval: "7-9.9", value: 0.177 },
        { interval: "10-14.9", value: 0.187 },
        { interval: "15-19.9", value: 0.03 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [45, 54],
      speed: [
        { interval: "2-4.9", value: 0.187 },
        { interval: "5-6.9", value: 0.167 },
        { interval: "7-9.9", value: 0.157 },
        { interval: "10-14.9", value: 0.098 },
        { interval: "15-19.9", value: 0.059 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [55, 64],
      speed: [
        { interval: "2-4.9", value: 0.108 },
        { interval: "5-6.9", value: 0.187 },
        { interval: "7-9.9", value: 0.157 },
        { interval: "10-14.9", value: 0.138 },
        { interval: "15-19.9", value: 0 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [65, 74],
      speed: [
        { interval: "2-4.9", value: 0.167 },
        { interval: "5-6.9", value: 0.157 },
        { interval: "7-9.9", value: 0.079 },
        { interval: "10-14.9", value: 0.049 },
        { interval: "15-19.9", value: 0.01 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [75, 84],
      speed: [
        { interval: "2-4.9", value: 0.138 },
        { interval: "5-6.9", value: 0.216 },
        { interval: "7-9.9", value: 0.226 },
        { interval: "10-14.9", value: 0.039 },
        { interval: "15-19.9", value: 0 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [85, 94],
      speed: [
        { interval: "2-4.9", value: 0.148 },
        { interval: "5-6.9", value: 0.266 },
        { interval: "7-9.9", value: 0.295 },
        { interval: "10-14.9", value: 0.148 },
        { interval: "15-19.9", value: 0 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [95, 104],
      speed: [
        { interval: "2-4.9", value: 0.187 },
        { interval: "5-6.9", value: 0.246 },
        { interval: "7-9.9", value: 0.118 },
        { interval: "10-14.9", value: 0.256 },
        { interval: "15-19.9", value: 0.089 },
        { interval: "20+", value: 0.02 },
      ],
    },
    {
      angles: [105, 114],
      speed: [
        { interval: "2-4.9", value: 0.403 },
        { interval: "5-6.9", value: 0.403 },
        { interval: "7-9.9", value: 0.236 },
        { interval: "10-14.9", value: 0.187 },
        { interval: "15-19.9", value: 0.069 },
        { interval: "20+", value: 0.03 },
      ],
    },
    {
      angles: [115, 124],
      speed: [
        { interval: "2-4.9", value: 0.403 },
        { interval: "5-6.9", value: 0.423 },
        { interval: "7-9.9", value: 0.197 },
        { interval: "10-14.9", value: 0.384 },
        { interval: "15-19.9", value: 0.216 },
        { interval: "20+", value: 0.049 },
      ],
    },
    {
      angles: [125, 134],
      speed: [
        { interval: "2-4.9", value: 0.472 },
        { interval: "5-6.9", value: 0.571 },
        { interval: "7-9.9", value: 0.413 },
        { interval: "10-14.9", value: 0.767 },
        { interval: "15-19.9", value: 0.413 },
        { interval: "20+", value: 0.148 },
      ],
    },
    {
      angles: [135, 144],
      speed: [
        { interval: "2-4.9", value: 0.551 },
        { interval: "5-6.9", value: 0.453 },
        { interval: "7-9.9", value: 0.659 },
        { interval: "10-14.9", value: 0.945 },
        { interval: "15-19.9", value: 0.659 },
        { interval: "20+", value: 0.266 },
      ],
    },
    {
      angles: [145, 154],
      speed: [
        { interval: "2-4.9", value: 0.374 },
        { interval: "5-6.9", value: 0.472 },
        { interval: "7-9.9", value: 0.659 },
        { interval: "10-14.9", value: 1.092 },
        { interval: "15-19.9", value: 0.394 },
        { interval: "20+", value: 0.089 },
      ],
    },
    {
      angles: [155, 164],
      speed: [
        { interval: "2-4.9", value: 0.492 },
        { interval: "5-6.9", value: 0.364 },
        { interval: "7-9.9", value: 0.571 },
        { interval: "10-14.9", value: 0.994 },
        { interval: "15-19.9", value: 0.394 },
        { interval: "20+", value: 0.187 },
      ],
    },
    {
      angles: [165, 174],
      speed: [
        { interval: "2-4.9", value: 0.492 },
        { interval: "5-6.9", value: 0.453 },
        { interval: "7-9.9", value: 0.453 },
        { interval: "10-14.9", value: 0.964 },
        { interval: "15-19.9", value: 0.305 },
        { interval: "20+", value: 0.108 },
      ],
    },
    {
      angles: [175, 184],
      speed: [
        { interval: "2-4.9", value: 0.167 },
        { interval: "5-6.9", value: 0.325 },
        { interval: "7-9.9", value: 0.443 },
        { interval: "10-14.9", value: 0.866 },
        { interval: "15-19.9", value: 0.384 },
        { interval: "20+", value: 0.049 },
      ],
    },
    {
      angles: [185, 194],
      speed: [
        { interval: "2-4.9", value: 0.315 },
        { interval: "5-6.9", value: 0.246 },
        { interval: "7-9.9", value: 0.453 },
        { interval: "10-14.9", value: 0.689 },
        { interval: "15-19.9", value: 0.364 },
        { interval: "20+", value: 0.089 },
      ],
    },
    {
      angles: [195, 204],
      speed: [
        { interval: "2-4.9", value: 0.413 },
        { interval: "5-6.9", value: 0.581 },
        { interval: "7-9.9", value: 0.502 },
        { interval: "10-14.9", value: 0.689 },
        { interval: "15-19.9", value: 0.167 },
        { interval: "20+", value: 0.03 },
      ],
    },
    {
      angles: [205, 214],
      speed: [
        { interval: "2-4.9", value: 0.541 },
        { interval: "5-6.9", value: 0.531 },
        { interval: "7-9.9", value: 0.394 },
        { interval: "10-14.9", value: 0.521 },
        { interval: "15-19.9", value: 0.098 },
        { interval: "20+", value: 0.049 },
      ],
    },
    {
      angles: [215, 224],
      speed: [
        { interval: "2-4.9", value: 0.61 },
        { interval: "5-6.9", value: 0.492 },
        { interval: "7-9.9", value: 0.571 },
        { interval: "10-14.9", value: 0.659 },
        { interval: "15-19.9", value: 0.157 },
        { interval: "20+", value: 0.049 },
      ],
    },
    {
      angles: [225, 234],
      speed: [
        { interval: "2-4.9", value: 0.64 },
        { interval: "5-6.9", value: 0.758 },
        { interval: "7-9.9", value: 0.512 },
        { interval: "10-14.9", value: 0.699 },
        { interval: "15-19.9", value: 0.177 },
        { interval: "20+", value: 0.01 },
      ],
    },
    {
      angles: [235, 244],
      speed: [
        { interval: "2-4.9", value: 0.718 },
        { interval: "5-6.9", value: 0.531 },
        { interval: "7-9.9", value: 0.285 },
        { interval: "10-14.9", value: 0.236 },
        { interval: "15-19.9", value: 0.02 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [245, 254],
      speed: [
        { interval: "2-4.9", value: 0.571 },
        { interval: "5-6.9", value: 0.482 },
        { interval: "7-9.9", value: 0.216 },
        { interval: "10-14.9", value: 0.108 },
        { interval: "15-19.9", value: 0 },
        { interval: "20+", value: 0 },
      ],
    },
    {
      angles: [255, 264],
      speed: [
        { interval: "2-4.9", value: 0.62 },
        { interval: "5-6.9", value: 0.384 },
        { interval: "7-9.9", value: 0.197 },
        { interval: "10-14.9", value: 0.207 },
        { interval: "15-19.9", value: 0.039 },
        { interval: "20+", value: 0.01 },
      ],
    },
    {
      angles: [265, 274],
      speed: [
        { interval: "2-4.9", value: 0.62 },
        { interval: "5-6.9", value: 0.521 },
        { interval: "7-9.9", value: 0.551 },
        { interval: "10-14.9", value: 0.531 },
        { interval: "15-19.9", value: 0.167 },
        { interval: "20+", value: 0.01 },
      ],
    },
    {
      angles: [275, 284],
      speed: [
        { interval: "2-4.9", value: 0.62 },
        { interval: "5-6.9", value: 0.64 },
        { interval: "7-9.9", value: 0.423 },
        { interval: "10-14.9", value: 0.738 },
        { interval: "15-19.9", value: 0.325 },
        { interval: "20+", value: 0.079 },
      ],
    },
    {
      angles: [285, 294],
      speed: [
        { interval: "2-4.9", value: 0.394 },
        { interval: "5-6.9", value: 0.59 },
        { interval: "7-9.9", value: 0.443 },
        { interval: "10-14.9", value: 0.945 },
        { interval: "15-19.9", value: 0.453 },
        { interval: "20+", value: 0.197 },
      ],
    },
    {
      angles: [295, 304],
      speed: [
        { interval: "2-4.9", value: 0.325 },
        { interval: "5-6.9", value: 0.699 },
        { interval: "7-9.9", value: 0.62 },
        { interval: "10-14.9", value: 1.702 },
        { interval: "15-19.9", value: 0.954 },
        { interval: "20+", value: 0.64 },
      ],
    },
    {
      angles: [305, 314],
      speed: [
        { interval: "2-4.9", value: 0.433 },
        { interval: "5-6.9", value: 0.6 },
        { interval: "7-9.9", value: 0.945 },
        { interval: "10-14.9", value: 2.391 },
        { interval: "15-19.9", value: 1.663 },
        { interval: "20+", value: 1.289 },
      ],
    },
    {
      angles: [315, 324],
      speed: [
        { interval: "2-4.9", value: 0.403 },
        { interval: "5-6.9", value: 0.669 },
        { interval: "7-9.9", value: 1.171 },
        { interval: "10-14.9", value: 2.706 },
        { interval: "15-19.9", value: 1.84 },
        { interval: "20+", value: 1.938 },
      ],
    },
    {
      angles: [325, 334],
      speed: [
        { interval: "2-4.9", value: 0.364 },
        { interval: "5-6.9", value: 0.492 },
        { interval: "7-9.9", value: 0.748 },
        { interval: "10-14.9", value: 2.184 },
        { interval: "15-19.9", value: 1.092 },
        { interval: "20+", value: 0.945 },
      ],
    },
    {
      angles: [335, 344],
      speed: [
        { interval: "2-4.9", value: 0.335 },
        { interval: "5-6.9", value: 0.531 },
        { interval: "7-9.9", value: 0.443 },
        { interval: "10-14.9", value: 1.446 },
        { interval: "15-19.9", value: 0.669 },
        { interval: "20+", value: 0.344 },
      ],
    },
    {
      angles: [345, 354],
      speed: [
        { interval: "2-4.9", value: 0.354 },
        { interval: "5-6.9", value: 0.521 },
        { interval: "7-9.9", value: 0.403 },
        { interval: "10-14.9", value: 0.984 },
        { interval: "15-19.9", value: 0.354 },
        { interval: "20+", value: 0.148 },
      ],
    },
  ],
};

const points = [
  "N",
  "NNE",
  "NE",
  "ENE",
  "E",
  "ESE",
  "SE",
  "SSE",
  "S",
  "SSW",
  "SW",
  "WSW",
  "W",
  "WNW",
  "NW",
  "NNW",
];

const size = 500;
const margin = 40;
const radius = size / 2;
const innerRadius = radius / 10;

const legendHeight = 60;
const gapHeight = 40;

const { calm, directions } = data;

const intervals = directions[0].speed.map(({ interval }) => interval);

const colors = Array(intervals.length)
  .fill()
  .map((_, i, { length }) => d3.interpolateTurbo((i + 1) / length));

const maxCumulativeValue = d3.max(directions, (d) =>
  d.speed.reduce((a, c) => a + c.value, 0)
);

const scaleLegend = d3.scaleBand().domain(intervals).range([0, size]);
const scalePoints = d3.scaleBand().domain(points).range([0, 360]);

const scaleColor = d3.scaleOrdinal().domain(intervals).range(colors);

const scaleValue = d3
  .scaleLinear()
  .domain([0, maxCumulativeValue])
  .range([innerRadius, radius])
  .nice();

const ticksValue = scaleValue.ticks(4).slice(1);

const arc = d3.arc();

const windRose = directions.map(({ angles, speed }) => {
  let [startAngle, endAngle] = angles.map((d) => (d / 180) * Math.PI);

  if (endAngle < startAngle) {
    endAngle += Math.PI * 2;
  }

  let currentValue = 0;
  const windRoseSpeed = [];

  for (const { interval, value } of speed) {
    const innerRadius = scaleValue(currentValue);
    currentValue += value;
    const outerRadius = scaleValue(currentValue);

    windRoseSpeed.push({
      interval,
      value,
      innerRadius,
      outerRadius,
      startAngle,
      endAngle,
    });
  }

  return {
    angles,
    speed: windRoseSpeed,
  };
});

const svg = d3
  .select("body")
  .append("svg")
  .attr(
    "viewBox",
    `0 0 ${size + margin * 2} ${size + margin * 2 + gapHeight + legendHeight}`
  );

const group = svg
  .append("g")
  .attr("transform", `translate(${margin} ${margin})`);

const groupCenter = group
  .append("g")
  .attr("transform", `translate(${size / 2} ${size / 2})`);

const groupLegend = group.append("g");
const groupAxis = groupCenter.append("g");
const groupPoints = groupAxis.append("g");
const groupTicks = groupAxis.append("g");
const groupWindRose = groupCenter.append("g");

groupLegend.attr("transform", `translate(0 ${size + gapHeight})`);

groupLegend
  .append("rect")
  .attr("width", size)
  .attr("height", legendHeight)
  .attr("fill", "none")
  .attr("stroke", "currentColor")
  .attr("stroke-width", "0.5");

groupLegend
  .append("text")
  .attr("transform", (d) => `translate(${size / 2} 0)`)
  .attr("fill", "currentColor")
  .attr("text-anchor", "middle")
  .attr("dominant-baseline", "hanging")
  .attr("y", "5")
  .attr("font-size", "14")
  .text("Wind speed (mph)");

const groupsLegend = groupLegend
  .selectAll("g")
  .data(intervals)
  .enter()
  .append("g")
  .attr(
    "transform",
    (d) =>
      `translate(${scaleLegend(d) + scaleLegend.bandwidth() / 2} ${
        legendHeight - 16
      })`
  );

groupsLegend
  .append("rect")
  .attr("x", "-26")
  .attr("y", "-4")
  .attr("width", "24")
  .attr("height", "8")
  .attr("fill", (d) => scaleColor(d));

groupsLegend
  .append("text")
  .attr("x", "2")
  .attr("fill", "currentColor")
  .attr("dominant-baseline", "central")
  .attr("font-size", "14")
  .text((d) => d);

groupAxis
  .append("circle")
  .attr("r", radius)
  .attr("fill", "none")
  .attr("stroke", "currentColor")
  .attr("stroke-width", "0.5");

const groupsPoints = groupPoints
  .selectAll("g")
  .data(points)
  .enter()
  .append("g");

groupsPoints
  .append("path")
  .attr("transform", (d) => `rotate(${scalePoints(d)})`)
  .attr("d", `M 0 ${innerRadius * -1} V ${radius * -1}`)
  .attr("fill", "none")
  .attr("stroke", "currentColor")
  .attr("stroke-width", "0.5");

groupsPoints
  .append("text")
  .attr(
    "transform",
    (d) =>
      `rotate(${scalePoints(d)}) translate(0 ${(radius + 20) * -1}) rotate(${
        scalePoints(d) * -1
      })`
  )
  .attr("fill", "currentColor")
  .attr("text-anchor", "middle")
  .attr("dominant-baseline", "middle")
  .attr("font-size", "12")
  .text((d) => d);

const groupsTicks = groupTicks
  .selectAll("g")
  .data(ticksValue)
  .enter()
  .append("g");

groupsTicks
  .append("circle")
  .attr("r", (d) => scaleValue(d))
  .attr("fill", "none")
  .attr("stroke", "currentColor")
  .attr("stroke-width", "0.5");

groupsTicks
  .append("text")
  .attr(
    "transform",
    (d) => `rotate(-30) translate(${scaleValue(d) + 8} 0) rotate(30)`
  )
  .attr("fill", "currentColor")
  .attr("text-anchor", "middle")
  .attr("font-size", "12")
  .text((d) => `${d}%`);

groupWindRose
  .append("text")
  .attr("y", "-12")
  .attr("fill", "currentColor")
  .attr("text-anchor", "middle")
  .attr("dominant-baseline", "hanging")
  .attr("font-size", "10")
  .text("Calm")
  .append("tspan")
  .attr("x", "0")
  .attr("dy", "12")
  .text(`${calm}%`);

const groupsWindRose = groupWindRose
  .selectAll("g")
  .data(windRose)
  .enter()
  .append("g");

groupsWindRose
  .selectAll("path")
  .data((d) => d.speed)
  .enter()
  .append("path")
  .attr("d", arc)
  .attr("fill", (d) => scaleColor(d.interval));
